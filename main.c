#ifdef AS_WAV_PLAYBACK

#include "sdcard_driver.h"
#include "dac7571_driver.h"
#include "state_machine.h"

#define WAV_BUFF_LEN (2048)
uint8 wav_buff[WAV_BUFF_LEN];

enum State state;

void play_wav(uint16 _chunk_size) {
    uint16 cnt = 0;
    for(; cnt < _chunk_size; ++cnt) {
        uint16 data = wav_buff[cnt];

        while(state == pause);

        dac7571_write_data(data << 3);
        __delay_cycles(1800); // magic
    }
}

int main() {
    WDTCTL = WDTPW + WDTHOLD;

    __enable_interrupt();
    state_init();
    btn_io_init();
    sdcard_init();

    while(1) {
        if(state == stop)
            continue;

        sdcard_load_wav(wav_buff, sizeof(wav_buff), play_wav);
        state = stop;
    }

    return 0;
}

#pragma vector = PORT1_VECTOR
DECLEAR_STATE_CALLBACK

#endif


#ifdef AS_LYRIC_DISPLAY

#include "paper_driver.h"
#include "img_data.h"
#include "state_machine.h"

#define IMG_NUM 10

enum State state;

const uint8* img[IMG_NUM] = {
    g_image_1,
    g_image_2,
    g_image_3,
    g_image_4,
    g_image_5,
    g_image_6,
    g_image_1,
    g_image_2,
    g_image_6,
    g_image_6,
};

const uint32 delay[IMG_NUM] = {
    22500,
    7500,
    6500,
    29000,
    7000,
    7000,
    7000,
    7000,
    6000,
    14000
};

int main() {
    WDTCTL = WDTPW + WDTHOLD;

    __enable_interrupt();
    state_init();
    btn_io_init();
    paper_init();

    paper_display_mono(0xff);

    while(1) {
        if(state == stop)
            continue;

        uint8 idx = 0;
        for(; idx < IMG_NUM; ++idx) {
            paper_display_img(img[idx]);
            delay_ms(delay[idx]);
        }

        state = stop;
        paper_display_mono(0xff);
    }

    return 0;
}

#pragma vector = PORT1_VECTOR
DECLEAR_STATE_CALLBACK

#endif


#ifdef AS_LED_DISPLAY

#include "max7219_driver.h"
#include "state_machine.h"

#define FRAME_NUM 33

enum State state;

const uint8 frames[FRAME_NUM][8] = {
    {0x27, 0x65, 0x25, 0x27, 0x21, 0x21, 0x21, 0x27},
    {0xa7, 0xa5, 0xa5, 0xe7, 0x21, 0x21, 0x21, 0x27},
    {0xe7, 0x25, 0x25, 0xe5, 0x85, 0x85, 0x85, 0xe7},
    {0x27, 0x65, 0x25, 0x27, 0x21, 0x21, 0x21, 0x27},
    {0xe7, 0x25, 0x25, 0x25, 0x25, 0x25, 0x25, 0x27},
    {0x38, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38},
    {0x66, 0x99, 0x81, 0x81, 0x81, 0x42, 0x24, 0x18},
    {0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x7c},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
    {0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03},
    {0x06, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x06},
    {0x0d, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x0d},
    {0x1a, 0x12, 0x12, 0x13, 0x12, 0x12, 0x12, 0x1a},
    {0x35, 0x25, 0x25, 0x27, 0x25, 0x25, 0x25, 0x35},
    {0x6a, 0x4a, 0x4a, 0x4e, 0x4a, 0x4a, 0x4a, 0x6a},
    {0xd5, 0x95, 0x95, 0x9d, 0x95, 0x95, 0x95, 0xd5},
    {0xaa, 0x2a, 0x2a, 0x3a, 0x2a, 0x2a, 0x2a, 0xaa},
    {0x55, 0x55, 0x55, 0x75, 0x55, 0x55, 0x55, 0x55},
    {0xaa, 0xaa, 0xaa, 0xeb, 0xaa, 0xaa, 0xaa, 0xaa},
    {0x54, 0x54, 0x54, 0xd6, 0x55, 0x54, 0x54, 0x54},
    {0xa9, 0xa9, 0xa9, 0xad, 0xab, 0xa9, 0xa9, 0xa9},
    {0x52, 0x52, 0x52, 0x5a, 0x56, 0x52, 0x52, 0x52},
    {0xa5, 0xa5, 0xa5, 0xb5, 0xad, 0xa5, 0xa5, 0xa5},
    {0x4b, 0x4a, 0x4a, 0x6b, 0x5a, 0x4a, 0x4a, 0x4a},
    {0x97, 0x95, 0x95, 0xd7, 0xb5, 0x95, 0x95, 0x95},
    {0x2e, 0x2a, 0x2a, 0xae, 0x6a, 0x2a, 0x2a, 0x2a},
    {0x5c, 0x54, 0x54, 0x5c, 0xd4, 0x54, 0x54, 0x54},
    {0xb8, 0xa8, 0xa8, 0xb8, 0xa8, 0xa8, 0xa8, 0xa8},
    {0x70, 0x50, 0x50, 0x70, 0x50, 0x50, 0x50, 0x50},
    {0xe0, 0xa0, 0xa0, 0xe0, 0xa0, 0xa0, 0xa0, 0xa0},
    {0xc0, 0x40, 0x40, 0xc0, 0x40, 0x40, 0x40, 0x40},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

const uint32 delay[FRAME_NUM] = {
    1500,
    1500,
    1500,
    1500,
    1500,
    1500,
    1500,
    1500,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300,
    300
};

int main() {
    WDTCTL = WDTPW + WDTHOLD;

    __enable_interrupt();
    state_init();
    btn_io_init();
    max7219_init();

    while(1) {
        if(state == stop)
            continue;

        // about 4min / 20s
        uint8 loop = 12;
        for(; loop; --loop)
            max7219_write_animation(frames, delay, FRAME_NUM);

        state = stop;
    }

    return 0;
}

#pragma vector = PORT1_VECTOR
DECLEAR_STATE_CALLBACK

#endif
